import{SvelteElement,append,attr,attribute_to_object,binding_callbacks,destroy_each,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe}from"../../../packages/svelte/internal/index.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy,tick}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{createResolver}from"../../../lib/path.js";import loglevelPlaceholder from"../../../lib/loglevel_placeholder.js";import"../widget/index.js";import"../add_widget/index.js";import"../workspace_finder/index.js";function get_each_context(t,e,n){const o=t.slice();return o[32]=e[n].title,o}function create_if_block_1(t){let e,n=t[2],o=[];for(let e=0;e<n.length;e+=1)o[e]=create_each_block(get_each_context(t,n,e));return{c(){for(let t=0;t<o.length;t+=1)o[t].c();e=empty()},m(t,n){for(let e=0;e<o.length;e+=1)o[e].m(t,n);insert(t,e,n)},p(t,i){if(324&i[0]){let a;for(n=t[2],a=0;a<n.length;a+=1){const s=get_each_context(t,n,a);o[a]?o[a].p(s,i):(o[a]=create_each_block(s),o[a].c(),o[a].m(e.parentNode,e))}for(;a<o.length;a+=1)o[a].d(1);o.length=n.length}},d(t){destroy_each(o,t),t&&detach(e)}}}function create_each_block(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-widget"),set_custom_element_data(e,"class","pined"),set_custom_element_data(e,"title",n=t[32])},m(n,a){insert(n,e,a),o||(i=[listen(e,"show-item-content",t[6]),listen(e,"remove",(function(){is_function(t[8](t[32]))&&t[8](t[32]).apply(this,arguments)}))],o=!0)},p(o,i){t=o,4&i[0]&&n!==(n=t[32])&&set_custom_element_data(e,"title",n)},d(t){t&&detach(e),o=!1,run_all(i)}}}function create_if_block(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-add-widget"),set_custom_element_data(e,"title",n=t[1]?.body.addWidget)},m(n,a){insert(n,e,a),o||(i=listen(e,"click",t[7]),o=!0)},p(t,o){2&o[0]&&n!==(n=t[1]?.body.addWidget)&&set_custom_element_data(e,"title",n)},d(t){t&&detach(e),o=!1,i()}}}function create_fragment(t){let e,n,o,i,a,s,r,l=t[2]?.length>0&&create_if_block_1(t),c=!t[3]&&create_if_block(t);return{c(){e=element("div"),n=element("hdl-dashboard-widget"),i=space(),l&&l.c(),a=space(),c&&c.c(),this.c=noop,set_custom_element_data(n,"title",o=t[1]?.body.recentlyAdded??getTitlePlaceholder(35)),set_custom_element_data(n,"readonly",""),attr(e,"class","viewport")},m(o,d){insert(o,e,d),append(e,n),t[16](n),append(e,i),l&&l.m(e,null),append(e,a),c&&c.m(e,null),s||(r=listen(n,"show-item-content",t[6]),s=!0)},p(t,i){2&i[0]&&o!==(o=t[1]?.body.recentlyAdded??getTitlePlaceholder(35))&&set_custom_element_data(n,"title",o),t[2]?.length>0?l?l.p(t,i):(l=create_if_block_1(t),l.c(),l.m(e,a)):l&&(l.d(1),l=null),t[3]?c&&(c.d(1),c=null):c?c.p(t,i):(c=create_if_block(t),c.c(),c.m(e,null))},i:noop,o:noop,d(n){n&&detach(e),t[16](null),l&&l.d(),c&&c.d(),s=!1,r()}}}const MAX_PINED=4,componentDisplayName="dashboard/body";function getItemsPlaceholders(){return Array.from({length:10},((t,e)=>({$id:String(e),title:getTitlePlaceholder(50),url:"javascript:void(0)"})))}function getTitlePlaceholder(t){const e=Math.round(Math.random()*t)+15;return" ".repeat(e)}async function getLastItems(){const t=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({offset:0,max:10,includeDraft:!0})});if(t.ok)return t.json();throw new Error("could not load last items")}async function getPined(){const t=await fetch("/api/get-config/dashboard");return(await t.json())?.pined}function groupBy(t,e){return e.reduce(((e,n)=>Object.assign(e,{[n[t]]:n})),{})}function instance(t,e,n){let o,i,a,s,r,l,c,d=noop,m=noop;t.$$.on_destroy.push((()=>d())),t.$$.on_destroy.push((()=>m()));const p={log:loglevelPlaceholder.getLogger()},{joi:u}=window,h=createValidator("dashboard/body"),g=createResolver(import.meta.url);let f,y,b,_,{layoutContext:w}=e,$=getItemsPlaceholders();function x(t){t&&p.log.error(t.toString())}function k({type:t}){if("itemsUpdate"===t)return Promise.all([j(),S()])}async function j(){n(10,$=await getLastItems())}async function C(){n(11,y=await getPined())}async function v(){const t=y.length-P().length;if(Math.abs(t)>0){n(2,_??=[]);const t=groupBy("title",_);n(2,_=y.map(((e,n)=>({title:e,items:t[e]?.items??getItemsPlaceholders()})))),await tick(),P().forEach(((t,e)=>Object.assign(t,{maxVisible:10,items:_[e].items,messages:b?.widget})))}return S()}function P(){return Array.from(f?.parentNode.querySelectorAll(".pined"))}async function S(){const t=groupBy("title",P());for await(const e of y.map(T))if(e){const{title:o,items:i}=e;n(2,_=_.map((t=>o!==t.title?t:e))),t[o].items=i}}async function T(t){try{const e=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({workspace:t,offset:0,max:300,includeDraft:!0})});if(e.ok)return{title:t,items:await e.json()};p.log.error(`could not load items of "${t}"`)}catch(e){p.log.error(`could not load items of "${t}":\n`,e)}}async function M({detail:t}){p.log.debug("pining workspace",t),await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:y?.length>0?Array.from(new Set([...y,t])):[t]})}),w.mutations.setModal()}return onMount((async()=>{n(1,b=await async function(){return(await fetch(g("../assets/messages.json"))).json()}());try{await Promise.all([j(),C()])}catch(t){p.log.error(t.toString())}})),onDestroy((()=>{w&&(w.sseClient.unsubscribe(`/api/${a}/notification`,k),w.sseClient.unsubscribe(`/api/${a}/dashboard/notification`,C),w.sseClient.offConnect(j),w.sseClient.offConnect(C))})),t.$$set=t=>{"layoutContext"in t&&n(9,w=t.layoutContext)},t.$$.update=()=>{512&t.$$.dirty[0]&&(n(5,o=w?.state.session),m(),m=subscribe(o,(t=>n(15,c=t)))),512&t.$$.dirty[0]&&(n(4,i=w?.state.workspaces),d(),d=subscribe(i,(t=>n(14,l=t)))),32768&t.$$.dirty[0]&&n(13,a=encodeURIComponent(c?.user.$id)),18432&t.$$.dirty[0]&&n(12,s=l?.filter((({name:t})=>!y?.includes(t))).map((({name:t})=>t))),6144&t.$$.dirty[0]&&n(3,r=y?.length>=4||0===s?.length),512&t.$$.dirty[0]&&h(w,"layoutContext",u.object().unknown()),1027&t.$$.dirty[0]&&f&&Object.assign(f,{items:$,messages:b?.widget}),512&t.$$.dirty[0]&&(p.log=w?.log.getLogger("layout/dashboard/body")),8704&t.$$.dirty[0]&&w&&(w.sseClient.subscribe(`/api/${a}/notification`,k,x),w.sseClient.subscribe(`/api/${a}/notification/dashboard`,C,x),w.sseClient.onConnect(j),w.sseClient.onConnect(C)),2048&t.$$.dirty[0]&&y&&v()},[f,b,_,r,i,o,function({detail:t}){p.log.debug("showing item",t),w?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:t.$id,type:t.type,title:t.title}})},function(){p.log.debug("opening workspace finder"),w?.mutations.setModal({component:"hdl-dashboard-workspace-finder",type:"web-component",paramsHaveAccessors:!0,onMount(t){t.addEventListener("pin",M)},params:{title:b?.body.pickWorkspace,workspaces:s}})},async function(t){if(p.log.debug("unpining workspace",t),y)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:y.filter((e=>e!==t))})})},w,$,y,s,a,l,c,function(t){binding_callbacks[t?"unshift":"push"]((()=>{f=t,n(0,f)}))}]}class Body extends SvelteElement{constructor(t){super(),this.shadowRoot.innerHTML="<style>:host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{display:flex;justify-content:center;flex-wrap:wrap;box-sizing:border-box;padding:1.431em;grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:3.5em;row-gap:3.5em\n  }@media(min-width: 1025px){.viewport{justify-content:flex-start\n  }}hdl-dashboard-widget,hdl-dashboard-add-widget{width:25em}hdl-dashboard-add-widget{min-height:25.125em}</style>",init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:9},null,[-1,-1]),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[9]}set layoutContext(t){this.$$set({layoutContext:t}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;