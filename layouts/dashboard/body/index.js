import{SvelteElement,append,attr,attribute_to_object,binding_callbacks,detach,element,flush,init,insert,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{getConfig}from"../../../lib/config.js";import configUpdates from"../--/lib/config_updates.js";import{gererateId}from"../--/lib/utils.js";import"../discovery/index.js";import"../pin_board/index.js";import"../search_builder/index.js";function create_fragment(t){let e,o,s,n,i,a,r,d;return{c(){e=element("div"),o=element("hdl-dashboard-discovery"),n=space(),i=element("hdl-dashboard-pin-board"),this.c=noop,set_custom_element_data(o,"initload",t[4]),set_custom_element_data(o,"config",t[2]),set_custom_element_data(o,"messages",s=t[1]?.reminder),set_custom_element_data(i,"pined",t[0]),set_custom_element_data(i,"configfetched",t[4]),set_custom_element_data(i,"messages",a=t[1]?.pinBoard),attr(e,"class","viewport")},m(s,a){insert(s,e,a),append(e,o),append(e,n),append(e,i),t[17](i),r||(d=[listen(o,"show-item-content",t[10]),listen(i,"show-item-content",t[10]),listen(i,"expand",t[11]),listen(i,"edit",t[12])],r=!0)},p(t,[e]){16&e&&set_custom_element_data(o,"initload",t[4]),4&e&&set_custom_element_data(o,"config",t[2]),2&e&&s!==(s=t[1]?.reminder)&&set_custom_element_data(o,"messages",s),1&e&&set_custom_element_data(i,"pined",t[0]),16&e&&set_custom_element_data(i,"configfetched",t[4]),2&e&&a!==(a=t[1]?.pinBoard)&&set_custom_element_data(i,"messages",a)},i:noop,o:noop,d(o){o&&detach(e),t[17](null),r=!1,run_all(d)}}}const log=logger.getLogger("layout/dashboard/component/body"),componentDisplayName="dashboard/body";function logAnyError(t){t&&log.error(t.toString())}async function getMessages(){return(await fetch(import.meta.resolve("../assets/messages.json"))).json()}function instance(t,e,o){let s,n,i,a,r,d,l,c,m,p,u,g,h,b=noop,y=noop,_=noop,f=noop,$=noop;t.$$.on_destroy.push((()=>b())),t.$$.on_destroy.push((()=>y())),t.$$.on_destroy.push((()=>_())),t.$$.on_destroy.push((()=>f())),t.$$.on_destroy.push((()=>$()));const{joi:w}=window,x=createValidator("dashboard/body");let C,v,j,k,{layoutContext:E}=e,M=!1;function S({type:t}){if("itemsUpdate"===t)return k?.refresh()}async function A(){o(4,M=!1);try{const t=await getConfig({layout:"dashboard",updates:configUpdates});t&&o(0,({pined:C,reminded:j}=t),C,o(2,j))}finally{o(4,M=!0)}}async function B({detail:t}){log.debug("pining search",t);const e={...t,id:t.id||gererateId(t.title)},o=C?.findIndex((({id:t})=>e.id===t))??-1,s=o>=0?C.with(o,e):[...C??[],e];await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:s})}),E.mutations.setModal()}return onMount((async()=>{o(1,v=await getMessages());try{await A()}catch(t){log.error(t.toString())}})),onDestroy((()=>{E&&(E.sseClient.unsubscribe(`/api/${l}/notification`,S),E.sseClient.unsubscribe(`/api/${l}/dashboard/notification`,A),E.sseClient.offConnect(A))})),t.$$set=t=>{"layoutContext"in t&&o(13,E=t.layoutContext)},t.$$.update=()=>{8192&t.$$.dirty&&(o(9,s=E?.state.session),b(),b=subscribe(s,(t=>o(15,m=t)))),8192&t.$$.dirty&&(o(8,n=E?.state.workspaces),$(),$=subscribe(n,(t=>o(16,h=t)))),65536&t.$$.dirty&&(i=h?.map((({name:t})=>t))),8192&t.$$.dirty&&(o(7,a=E?.state.tags),f(),f=subscribe(a,(t=>o(22,g=t)))),8192&t.$$.dirty&&(o(6,r=E?.state.connections),y(),y=subscribe(r,(t=>o(20,p=t)))),8192&t.$$.dirty&&(o(5,d=E?.computed.tagAliases),_(),_=subscribe(d,(t=>o(21,u=t)))),32768&t.$$.dirty&&o(14,l=encodeURIComponent(m?.user.$id)),1&t.$$.dirty&&(c=C?.map((({title:t})=>t))),8192&t.$$.dirty&&x(E,"layoutContext",w.object().unknown()),24576&t.$$.dirty&&E&&(E.sseClient.subscribe(`/api/${l}/notification`,S,logAnyError),E.sseClient.subscribe(`/api/${l}/notification/dashboard`,A,logAnyError),E.sseClient.onConnect(A))},[C,v,j,k,M,d,r,a,n,s,function({detail:t}){log.debug("showing item",t),E?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:t.$id,type:t.type,title:t.title}})},function({detail:t}){E?(E.mutations.setSearch(t),E.mutations.switchToDefaultLayout()):log.warn("layoutContext is not set yet")},function({detail:t}){log.debug(t?.id?`editing search "${t.id}"`:"adding search"),E?.mutations.setModal({component:"hdl-dashboard-search-builder",type:"web-component",paramsHaveAccessors:!0,onMount(t){t.addEventListener("pin",B)},params:{messages:v?.body.buildSearch,workspaces:i,tags:g,tagaliases:u,connections:p,user:m?.user,forbiddennames:c?.filter((e=>e!==t?.title)),...t}})},E,l,m,h,function(t){binding_callbacks[t?"unshift":"push"]((()=>{k=t,o(3,k)}))}]}class Body extends SvelteElement{constructor(t){super();const e=document.createElement("style");e.textContent=":host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{--row-gap:3.5em;--pin-board-row-gap:var(--row-gap);padding:1.431em 2.5em\n  }.viewport>*:not(:last-child){margin-bottom:var(--row-gap)}",this.shadowRoot.appendChild(e),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:13},null),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[13]}set layoutContext(t){this.$$set({layoutContext:t}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;