import{SvelteElement,append,attr,attribute_to_object,destroy_each,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe}from"../../../packages/svelte/internal/index.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{createResolver}from"../../../lib/path.js";import loglevelPlaceholder from"../../../lib/loglevel_placeholder.js";import"../widget/index.js";import"../add_widget/index.js";import"../workspace_finder/index.js";function get_each_context(e,t,o){const n=e.slice();return n[28]=t[o].title,n[29]=t[o].items,n}function create_if_block_1(e){let t,o=e[2],n=[];for(let t=0;t<o.length;t+=1)n[t]=create_each_block(get_each_context(e,o,t));return{c(){for(let e=0;e<n.length;e+=1)n[e].c();t=empty()},m(e,o){for(let t=0;t<n.length;t+=1)n[t].m(e,o);insert(e,t,o)},p(e,a){if(326&a[0]){let i;for(o=e[2],i=0;i<o.length;i+=1){const s=get_each_context(e,o,i);n[i]?n[i].p(s,a):(n[i]=create_each_block(s),n[i].c(),n[i].m(t.parentNode,t))}for(;i<n.length;i+=1)n[i].d(1);n.length=o.length}},d(e){destroy_each(n,e),e&&detach(t)}}}function create_each_block(e){let t,o,n,a,i,s,r;return{c(){t=element("hdl-dashboard-widget"),set_custom_element_data(t,"class","pined"),set_custom_element_data(t,"title",o=e[28]),set_custom_element_data(t,"items",n=e[29]),set_custom_element_data(t,"messages",a=e[1]?.widget),set_custom_element_data(t,"maxvisible",i=10)},m(o,n){insert(o,t,n),s||(r=[listen(t,"show-item-content",e[6]),listen(t,"remove",(function(){is_function(e[8](e[28]))&&e[8](e[28]).apply(this,arguments)}))],s=!0)},p(i,s){e=i,4&s[0]&&o!==(o=e[28])&&set_custom_element_data(t,"title",o),4&s[0]&&n!==(n=e[29])&&set_custom_element_data(t,"items",n),2&s[0]&&a!==(a=e[1]?.widget)&&set_custom_element_data(t,"messages",a)},d(e){e&&detach(t),s=!1,run_all(r)}}}function create_if_block(e){let t,o,n,a;return{c(){t=element("hdl-dashboard-add-widget"),set_custom_element_data(t,"title",o=e[1]?.body.addWidget)},m(o,i){insert(o,t,i),n||(a=listen(t,"click",e[7]),n=!0)},p(e,n){2&n[0]&&o!==(o=e[1]?.body.addWidget)&&set_custom_element_data(t,"title",o)},d(e){e&&detach(t),n=!1,a()}}}function create_fragment(e){let t,o,n,a,i,s,r,l,d=e[2]?.length>0&&create_if_block_1(e),c=!e[3]&&create_if_block(e);return{c(){t=element("div"),o=element("hdl-dashboard-widget"),i=space(),d&&d.c(),s=space(),c&&c.c(),this.c=noop,set_custom_element_data(o,"title",n=e[1]?.body.recentlyAdded??getTitlePlaceholder(35)),set_custom_element_data(o,"items",e[0]),set_custom_element_data(o,"messages",a=e[1]?.widget),set_custom_element_data(o,"readonly",""),attr(t,"class","viewport")},m(n,a){insert(n,t,a),append(t,o),append(t,i),d&&d.m(t,null),append(t,s),c&&c.m(t,null),r||(l=listen(o,"show-item-content",e[6]),r=!0)},p(e,i){2&i[0]&&n!==(n=e[1]?.body.recentlyAdded??getTitlePlaceholder(35))&&set_custom_element_data(o,"title",n),1&i[0]&&set_custom_element_data(o,"items",e[0]),2&i[0]&&a!==(a=e[1]?.widget)&&set_custom_element_data(o,"messages",a),e[2]?.length>0?d?d.p(e,i):(d=create_if_block_1(e),d.c(),d.m(t,s)):d&&(d.d(1),d=null),e[3]?c&&(c.d(1),c=null):c?c.p(e,i):(c=create_if_block(e),c.c(),c.m(t,null))},i:noop,o:noop,d(e){e&&detach(t),d&&d.d(),c&&c.d(),r=!1,l()}}}const MAX_PINED=4,componentDisplayName="dashboard/body";function getItemsPlaceholders(){return Array.from({length:10},((e,t)=>({$id:String(t),title:getTitlePlaceholder(50),url:"javascript:void(0)"})))}function getTitlePlaceholder(e){const t=Math.round(Math.random()*e)+15;return" ".repeat(t)}async function getLastItems(){const e=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({offset:0,max:10,includeDraft:!0})});if(e.ok)return e.json();throw new Error("could not load last items")}async function getPined(){const e=await fetch("/api/get-config/dashboard");return(await e.json())?.pined}function groupBy(e,t){return t.reduce(((t,o)=>Object.assign(t,{[o[e]]:o})),{})}function instance(e,t,o){let n,a,i,s,r,l,d,c=noop,m=noop;e.$$.on_destroy.push((()=>c())),e.$$.on_destroy.push((()=>m()));const u={log:loglevelPlaceholder.getLogger()},{joi:p}=window,h=createValidator("dashboard/body"),g=createResolver(import.meta.url);let f,_,y,{layoutContext:b}=t,w=getItemsPlaceholders();function $(e){e&&u.log.error(e.toString())}function x({type:e}){if("itemsUpdate"===e)return Promise.all([j(),v()])}async function j(){o(0,w=await getLastItems())}async function k(){o(10,f=await getPined())}async function v(){for await(const e of f.map(C))if(e){const{title:t}=e;o(2,y=y.map((o=>t!==o.title?o:e)))}}async function C(e){try{const t=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({workspace:e,offset:0,max:300,includeDraft:!0})});if(t.ok)return{title:e,items:await t.json()};u.log.error(`could not load items of "${e}"`)}catch(t){u.log.error(`could not load items of "${e}":\n`,t)}}async function P({detail:e}){u.log.debug("pining workspace",e),await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:f?.length>0?Array.from(new Set([...f,e])):[e]})}),b.mutations.setModal()}return onMount((async()=>{o(1,_=await async function(){return(await fetch(g("../assets/messages.json"))).json()}());try{await Promise.all([j(),k()])}catch(e){u.log.error(e.toString())}})),onDestroy((()=>{b&&(b.sseClient.unsubscribe(`/api/${i}/notification`,x),b.sseClient.unsubscribe(`/api/${i}/dashboard/notification`,k),b.sseClient.offConnect(j),b.sseClient.offConnect(k))})),e.$$set=e=>{"layoutContext"in e&&o(9,b=e.layoutContext)},e.$$.update=()=>{512&e.$$.dirty[0]&&(o(5,n=b?.state.session),m(),m=subscribe(n,(e=>o(14,d=e)))),512&e.$$.dirty[0]&&(o(4,a=b?.state.workspaces),c(),c=subscribe(a,(e=>o(13,l=e)))),16384&e.$$.dirty[0]&&o(12,i=encodeURIComponent(d?.user.$id)),9216&e.$$.dirty[0]&&o(11,s=l?.filter((({name:e})=>!f?.includes(e))).map((({name:e})=>e))),3072&e.$$.dirty[0]&&o(3,r=f?.length>=4||0===s?.length),512&e.$$.dirty[0]&&h(b,"layoutContext",p.object().unknown()),512&e.$$.dirty[0]&&(u.log=b?.log.getLogger("layout/dashboard/body")),4608&e.$$.dirty[0]&&b&&(b.sseClient.subscribe(`/api/${i}/notification`,x,$),b.sseClient.subscribe(`/api/${i}/notification/dashboard`,k,$),b.sseClient.onConnect(j),b.sseClient.onConnect(k)),1024&e.$$.dirty[0]&&f&&async function(){const e=f.length-(y?.length??0);if(Math.abs(e)>0){o(2,y??=[]);const e=groupBy("title",y);o(2,y=f.map(((t,o)=>({title:t,items:e[t]?.items??getItemsPlaceholders()}))))}v()}()},[w,_,y,r,a,n,function({detail:e}){u.log.debug("showing item",e),b?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:e.$id,type:e.type,title:e.title}})},function(){u.log.debug("opening workspace finder"),b?.mutations.setModal({component:"hdl-dashboard-workspace-finder",type:"web-component",paramsHaveAccessors:!0,onMount(e){e.addEventListener("pin",P)},params:{title:_?.body.pickWorkspace,workspaces:s}})},async function(e){if(u.log.debug("unpining workspace",e),f)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:f.filter((t=>t!==e))})})},b,f,s,i,l,d]}class Body extends SvelteElement{constructor(e){super(),this.shadowRoot.innerHTML="<style>:host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{display:flex;justify-content:center;flex-wrap:wrap;box-sizing:border-box;padding:1.431em;grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:3.5em;row-gap:3.5em\n  }@media(min-width: 1025px){.viewport{justify-content:flex-start\n  }}hdl-dashboard-widget,hdl-dashboard-add-widget{width:25em}hdl-dashboard-add-widget{min-height:25.125em}</style>",init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:9},null,[-1,-1]),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[9]}set layoutContext(e){this.$$set({layoutContext:e}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;