import{SvelteElement,append,attr,attribute_to_object,binding_callbacks,destroy_block,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe,update_keyed_each}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy,tick}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{getConfig}from"../../../lib/config.js";import configUpdates from"./lib/config_updates.js";import{gererateId}from"./lib/utils.js";import"../widget/index.js";import"../add_widget/index.js";import"../search_builder/index.js";import"../reminder/index.js";function get_each_context(t,e,n){const o=t.slice();return o[34]=e[n].id,o[35]=e[n].title,o[36]=e[n].items,o}function create_if_block_2(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-reminder"),set_custom_element_data(e,"items",t[3]),set_custom_element_data(e,"messages",n=t[0]?.reminder)},m(n,s){insert(n,e,s),o||(i=listen(e,"show-item-content",t[10]),o=!0)},p(t,o){8&o[0]&&set_custom_element_data(e,"items",t[3]),1&o[0]&&n!==(n=t[0]?.reminder)&&set_custom_element_data(e,"messages",n)},d(t){t&&detach(e),o=!1,i()}}}function create_if_block_1(t){let e,n=[],o=new Map,i=t[1];const s=t=>t[34];for(let e=0;e<i.length;e+=1){let a=get_each_context(t,i,e),r=s(a);o.set(r,n[e]=create_each_block(r,a))}return{c(){for(let t=0;t<n.length;t+=1)n[t].c();e=empty()},m(t,o){for(let e=0;e<n.length;e+=1)n[e]&&n[e].m(t,o);insert(t,e,o)},p(t,a){15363&a[0]&&(i=t[1],n=update_keyed_each(n,a,s,1,t,i,o,e.parentNode,destroy_block,create_each_block,e,get_each_context))},d(t){for(let e=0;e<n.length;e+=1)n[e].d(t);t&&detach(e)}}}function create_each_block(t,e){let n,o,i,s,a,r,d,c;return{key:t,first:null,c(){n=element("hdl-dashboard-widget"),set_custom_element_data(n,"class","pined"),set_custom_element_data(n,"id",o=e[34]),set_custom_element_data(n,"title",i=e[35]),set_custom_element_data(n,"items",s=e[36]),set_custom_element_data(n,"messages",a=e[0]?.widget),set_custom_element_data(n,"maxvisible",r=10),this.first=n},m(t,o){insert(t,n,o),d||(c=[listen(n,"show-item-content",e[10]),listen(n,"expand",(function(){is_function(e[11](e[34]))&&e[11](e[34]).apply(this,arguments)})),listen(n,"edit",(function(){is_function(e[12](e[34]))&&e[12](e[34]).apply(this,arguments)})),listen(n,"remove",(function(){is_function(e[13](e[34]))&&e[13](e[34]).apply(this,arguments)}))],d=!0)},p(t,r){e=t,2&r[0]&&o!==(o=e[34])&&set_custom_element_data(n,"id",o),2&r[0]&&i!==(i=e[35])&&set_custom_element_data(n,"title",i),2&r[0]&&s!==(s=e[36])&&set_custom_element_data(n,"items",s),1&r[0]&&a!==(a=e[0]?.widget)&&set_custom_element_data(n,"messages",a)},d(t){t&&detach(n),d=!1,run_all(c)}}}function create_if_block(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-add-widget"),set_custom_element_data(e,"title",n=t[0]?.body.addWidget)},m(n,s){insert(n,e,s),o||(i=listen(e,"click",t[12]),o=!0)},p(t,o){1&o[0]&&n!==(n=t[0]?.body.addWidget)&&set_custom_element_data(e,"title",n)},d(t){t&&detach(e),o=!1,i()}}}function create_fragment(t){let e,n,o,i,s=t[3]&&create_if_block_2(t),a=t[1]?.length>0&&create_if_block_1(t),r=!t[4]&&create_if_block(t);return{c(){e=element("div"),s&&s.c(),n=space(),o=element("section"),a&&a.c(),i=space(),r&&r.c(),this.c=noop,attr(o,"class","widgets"),attr(e,"class","viewport")},m(d,c){insert(d,e,c),s&&s.m(e,null),append(e,n),append(e,o),a&&a.m(o,null),append(o,i),r&&r.m(o,null),t[20](e)},p(t,d){t[3]?s?s.p(t,d):(s=create_if_block_2(t),s.c(),s.m(e,n)):s&&(s.d(1),s=null),t[1]?.length>0?a?a.p(t,d):(a=create_if_block_1(t),a.c(),a.m(o,i)):a&&(a.d(1),a=null),t[4]?r&&(r.d(1),r=null):r?r.p(t,d):(r=create_if_block(t),r.c(),r.m(o,null))},i:noop,o:noop,d(n){n&&detach(e),s&&s.d(),a&&a.d(),r&&r.d(),t[20](null)}}}const log=logger.getLogger("layout/dashboard/component/body"),MAX_PINED=4,componentDisplayName="dashboard/body";function logAnyError(t){t&&log.error(t.toString())}function getItemsPlaceholders(t,e=" "){return Array.from({length:t},((t,n)=>({$id:String(n),title:getTitlePlaceholder(50,e),url:"javascript:void(0)"})))}function getTitlePlaceholder(t,e){const n=Math.round(Math.random()*t)+15;return e.repeat(n)}async function getMessages(){return(await fetch(import.meta.resolve("../assets/messages.json"))).json()}async function fetchReminded(){const t={includeDraft:!0};let e,n;{const n=await fetch("/api/count-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error("could not count items");e=await n.json()}{const o=Math.max(0,e-20),i=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,offset:Math.floor(Math.random()*o)})});if(!i.ok)throw new Error("could not load reminded items");n=await i.json()}const o=pickItems(n);return await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reminded:{lastModified:Date.now(),items:o.map((({$id:t,title:e,url:n,snapshot:o,icon:i,type:s})=>({$id:t,title:e,url:n,snapshot:o,icon:i,type:s})))}})}),o}function pickItems(t){const e=[...t],n=[],o=Math.min(7,e.length);for(let t=0;t<o;t++){const t=Math.floor(Math.random()*e.length);n.push(e[t]),e.splice(t,1)}return n}function groupBy(t,e){return e.reduce(((e,n)=>Object.assign(e,{[n[t]]:n})),{})}async function getPinedWidgetData({id:t,title:e,search:n}){try{const o=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok)return{id:t,title:e,items:await o.json()};log.error(`could not load items of "${e}"(${t}) pined search`),log.debug("search:\n",n)}catch(o){log.error(`could not load items of "${e}"(${t}) pined search:\n`,o),log.debug("search:\n",n)}}function instance(t,e,n){let o,i,s,a,r,d,c,l,m,u,p,h,g,f,_=noop,y=noop,b=noop,w=noop,$=noop;t.$$.on_destroy.push((()=>_())),t.$$.on_destroy.push((()=>y())),t.$$.on_destroy.push((()=>b())),t.$$.on_destroy.push((()=>w())),t.$$.on_destroy.push((()=>$()));const{joi:k}=window,x=createValidator("dashboard/body");let j,C,v,M,S,{layoutContext:T}=e,O=!1;function P({type:t}){if("itemsUpdate"===t)return D()}async function E(){const t=await async function(){n(16,O=!1);const t=await getConfig({layout:"dashboard",updates:configUpdates});return n(16,O=!0),t}();n(15,j=t?.pined);const e=t?.reminded;if(!e||Date.now()-e.lastModified>=6048e5)try{n(3,S=await fetchReminded())}catch(t){log.error("could not load reminded items:\n",t)}else n(3,S=e.items)}async function D(){for await(const t of j.map(getPinedWidgetData))if(t){const{id:e}=t;n(1,v=v.map((n=>e!==n.id?n:t))),tick().then((()=>M.querySelector("#"+e)?.scrollToTop()))}}async function A({detail:t}){log.debug("pining search",t);const e={...t,id:t.id||gererateId(t.title)},n=j?.findIndex((({id:t})=>e.id===t))??-1,o=n>=0?j.with(n,e):[...j??[],e];await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:o})}),T.mutations.setModal()}return onMount((async()=>{n(0,C=await getMessages());try{await E()}catch(t){log.error(t.toString())}})),onDestroy((()=>{T&&(T.sseClient.unsubscribe(`/api/${d}/notification`,P),T.sseClient.unsubscribe(`/api/${d}/dashboard/notification`,E),T.sseClient.offConnect(E))})),t.$$set=t=>{"layoutContext"in t&&n(14,T=t.layoutContext)},t.$$.update=()=>{16384&t.$$.dirty[0]&&(n(9,o=T?.state.session),_(),_=subscribe(o,(t=>n(18,u=t)))),16384&t.$$.dirty[0]&&(n(8,i=T?.state.workspaces),$(),$=subscribe(i,(t=>n(19,f=t)))),16384&t.$$.dirty[0]&&(n(7,s=T?.state.tags),w(),w=subscribe(s,(t=>n(25,g=t)))),16384&t.$$.dirty[0]&&(n(6,a=T?.state.connections),y(),y=subscribe(a,(t=>n(23,p=t)))),16384&t.$$.dirty[0]&&(n(5,r=T?.computed.tagAliases),b(),b=subscribe(r,(t=>n(24,h=t)))),262144&t.$$.dirty[0]&&n(17,d=encodeURIComponent(u?.user.$id)),98304&t.$$.dirty[0]&&n(4,c=!O||j?.length>=4),524288&t.$$.dirty[0]&&(l=f?.map((({name:t})=>t))),32768&t.$$.dirty[0]&&(m=j?.map((({title:t})=>t))),16384&t.$$.dirty[0]&&x(T,"layoutContext",k.object().unknown()),147456&t.$$.dirty[0]&&T&&(T.sseClient.subscribe(`/api/${d}/notification`,P,logAnyError),T.sseClient.subscribe(`/api/${d}/notification/dashboard`,E,logAnyError),T.sseClient.onConnect(E)),32768&t.$$.dirty[0]&&j&&async function(){const t=j.length-(v?.length??0);if(Math.abs(t)>0){n(1,v??=[]);const t=groupBy("id",v);n(1,v=j.map((({id:e,title:n},o)=>({id:e,title:n,items:t[e]?.items??getItemsPlaceholders(10)}))))}D()}()},[C,v,M,S,c,r,a,s,i,o,function({detail:t}){log.debug("showing item",t),T?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:t.$id,type:t.type,title:t.title}})},function(t){const e=j.find((e=>e.id===t));T?(T.mutations.setSearch(e.search),T.mutations.switchToDefaultLayout()):log.warn("layoutContext is not set yet")},function(t){log.debug(t?`editing search "${t}"`:"opening search builder");const e=j?.find((e=>e.id===t));T?.mutations.setModal({component:"hdl-dashboard-search-builder",type:"web-component",paramsHaveAccessors:!0,onMount(t){t.addEventListener("pin",A)},params:{messages:C?.body.buildSearch,workspaces:l,tags:g,tagaliases:h,connections:p,user:u?.user,forbiddennames:m?.filter((t=>t!==e?.title)),...e}})},async function(t){if(log.debug("unpining search",t),j)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:j.filter((e=>e.id!==t))})})},T,j,O,d,u,f,function(t){binding_callbacks[t?"unshift":"push"]((()=>{M=t,n(2,M)}))}]}class Body extends SvelteElement{constructor(t){super();const e=document.createElement("style");e.textContent=":host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{--row-gap:3.5em;padding:1.431em 2.5em\n  }.viewport>*:not(:last-child){margin-bottom:var(--row-gap)}.widgets{display:grid;grid-template-columns:repeat(auto-fill, minmax(25em, 1fr));grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:var(--row-gap);row-gap:var(--row-gap)}hdl-dashboard-add-widget{min-height:25.125em}",this.shadowRoot.appendChild(e),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:14},null,[-1,-1]),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[14]}set layoutContext(t){this.$$set({layoutContext:t}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;