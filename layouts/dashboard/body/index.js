import{SvelteElement,append,attr,attribute_to_object,binding_callbacks,destroy_block,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe,update_keyed_each}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy,tick}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{getConfig}from"../../../lib/config.js";import configUpdates from"./lib/config_updates.js";import{gererateId}from"./lib/utils.js";import"../widget/index.js";import"../add_widget/index.js";import"../search_builder/index.js";function get_each_context(t,e,n){const o=t.slice();return o[32]=e[n].id,o[33]=e[n].title,o[34]=e[n].items,o}function create_if_block_1(t){let e,n=[],o=new Map,i=t[1];const s=t=>t[32];for(let e=0;e<i.length;e+=1){let a=get_each_context(t,i,e),r=s(a);o.set(r,n[e]=create_each_block(r,a))}return{c(){for(let t=0;t<n.length;t+=1)n[t].c();e=empty()},m(t,o){for(let e=0;e<n.length;e+=1)n[e]&&n[e].m(t,o);insert(t,e,o)},p(t,a){7683&a[0]&&(i=t[1],n=update_keyed_each(n,a,s,1,t,i,o,e.parentNode,destroy_block,create_each_block,e,get_each_context))},d(t){for(let e=0;e<n.length;e+=1)n[e].d(t);t&&detach(e)}}}function create_each_block(t,e){let n,o,i,s,a,r,d,c;return{key:t,first:null,c(){n=element("hdl-dashboard-widget"),set_custom_element_data(n,"class","pined"),set_custom_element_data(n,"id",o=e[32]),set_custom_element_data(n,"title",i=e[33]),set_custom_element_data(n,"items",s=e[34]),set_custom_element_data(n,"messages",a=e[0]?.widget),set_custom_element_data(n,"maxvisible",r=10),this.first=n},m(t,o){insert(t,n,o),d||(c=[listen(n,"show-item-content",e[9]),listen(n,"expand",(function(){is_function(e[10](e[32]))&&e[10](e[32]).apply(this,arguments)})),listen(n,"edit",(function(){is_function(e[11](e[32]))&&e[11](e[32]).apply(this,arguments)})),listen(n,"remove",(function(){is_function(e[12](e[32]))&&e[12](e[32]).apply(this,arguments)}))],d=!0)},p(t,r){e=t,2&r[0]&&o!==(o=e[32])&&set_custom_element_data(n,"id",o),2&r[0]&&i!==(i=e[33])&&set_custom_element_data(n,"title",i),2&r[0]&&s!==(s=e[34])&&set_custom_element_data(n,"items",s),1&r[0]&&a!==(a=e[0]?.widget)&&set_custom_element_data(n,"messages",a)},d(t){t&&detach(n),d=!1,run_all(c)}}}function create_if_block(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-add-widget"),set_custom_element_data(e,"title",n=t[0]?.body.addWidget)},m(n,s){insert(n,e,s),o||(i=listen(e,"click",t[11]),o=!0)},p(t,o){1&o[0]&&n!==(n=t[0]?.body.addWidget)&&set_custom_element_data(e,"title",n)},d(t){t&&detach(e),o=!1,i()}}}function create_fragment(t){let e,n,o=t[1]?.length>0&&create_if_block_1(t),i=!t[3]&&create_if_block(t);return{c(){e=element("div"),o&&o.c(),n=space(),i&&i.c(),this.c=noop,attr(e,"class","viewport")},m(s,a){insert(s,e,a),o&&o.m(e,null),append(e,n),i&&i.m(e,null),t[18](e)},p(t,s){t[1]?.length>0?o?o.p(t,s):(o=create_if_block_1(t),o.c(),o.m(e,n)):o&&(o.d(1),o=null),t[3]?i&&(i.d(1),i=null):i?i.p(t,s):(i=create_if_block(t),i.c(),i.m(e,null))},i:noop,o:noop,d(n){n&&detach(e),o&&o.d(),i&&i.d(),t[18](null)}}}const log=logger.getLogger("layout/dashboard/component/body"),MAX_PINED=4,componentDisplayName="dashboard/body";function logAnyError(t){t&&log.error(t.toString())}function getItemsPlaceholders(){return Array.from({length:10},((t,e)=>({$id:String(e),title:getTitlePlaceholder(50),url:"javascript:void(0)"})))}function getTitlePlaceholder(t){const e=Math.round(Math.random()*t)+15;return" ".repeat(e)}async function getMessages(){return(await fetch(import.meta.resolve("../assets/messages.json"))).json()}function groupBy(t,e){return e.reduce(((e,n)=>Object.assign(e,{[n[t]]:n})),{})}async function getPinedWidgetData({id:t,title:e,search:n}){try{const o=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok)return{id:t,title:e,items:await o.json()};log.error(`could not load items of "${e}"(${t}) pined search`),log.debug("search:\n",n)}catch(o){log.error(`could not load items of "${e}"(${t}) pined search:\n`,o),log.debug("search:\n",n)}}function instance(t,e,n){let o,i,s,a,r,d,c,l,u,m,p,h,g,f,_=noop,b=noop,y=noop,$=noop,w=noop;t.$$.on_destroy.push((()=>_())),t.$$.on_destroy.push((()=>b())),t.$$.on_destroy.push((()=>y())),t.$$.on_destroy.push((()=>$())),t.$$.on_destroy.push((()=>w()));const{joi:x}=window,k=createValidator("dashboard/body");let j,C,v,S,{layoutContext:M}=e;function T({type:t}){if("itemsUpdate"===t)return P()}async function E(){n(14,j=await async function(){return(await getConfig({layout:"dashboard",updates:configUpdates}))?.pined}())}async function P(){for await(const t of j.map(getPinedWidgetData))if(t){const{id:e}=t;n(1,v=v.map((n=>e!==n.id?n:t))),tick().then((()=>S.querySelector("#"+e)?.scrollToTop()))}}async function A({detail:t}){log.debug("pining search",t);const e={...t,id:t.id||gererateId(t.title)},n=j?.findIndex((({id:t})=>e.id===t))??-1,o=n>=0?j.with(n,e):[...j??[],e];await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:o})}),M.mutations.setModal()}return onMount((async()=>{n(0,C=await getMessages());try{await E()}catch(t){log.error(t.toString())}})),onDestroy((()=>{M&&(M.sseClient.unsubscribe(`/api/${d}/notification`,T),M.sseClient.unsubscribe(`/api/${d}/dashboard/notification`,E),M.sseClient.offConnect(E))})),t.$$set=t=>{"layoutContext"in t&&n(13,M=t.layoutContext)},t.$$.update=()=>{8192&t.$$.dirty[0]&&(n(8,o=M?.state.session),_(),_=subscribe(o,(t=>n(16,m=t)))),8192&t.$$.dirty[0]&&(n(7,i=M?.state.workspaces),w(),w=subscribe(i,(t=>n(17,f=t)))),8192&t.$$.dirty[0]&&(n(6,s=M?.state.tags),$(),$=subscribe(s,(t=>n(23,g=t)))),8192&t.$$.dirty[0]&&(n(5,a=M?.state.connections),b(),b=subscribe(a,(t=>n(21,p=t)))),8192&t.$$.dirty[0]&&(n(4,r=M?.computed.tagAliases),y(),y=subscribe(r,(t=>n(22,h=t)))),65536&t.$$.dirty[0]&&n(15,d=encodeURIComponent(m?.user.$id)),16384&t.$$.dirty[0]&&n(3,c=j?.length>=4),131072&t.$$.dirty[0]&&(l=f?.map((({name:t})=>t))),16384&t.$$.dirty[0]&&(u=j?.map((({title:t})=>t))),8192&t.$$.dirty[0]&&k(M,"layoutContext",x.object().unknown()),40960&t.$$.dirty[0]&&M&&(M.sseClient.subscribe(`/api/${d}/notification`,T,logAnyError),M.sseClient.subscribe(`/api/${d}/notification/dashboard`,E,logAnyError),M.sseClient.onConnect(E)),16384&t.$$.dirty[0]&&j&&async function(){const t=j.length-(v?.length??0);if(Math.abs(t)>0){n(1,v??=[]);const t=groupBy("id",v);n(1,v=j.map((({id:e,title:n},o)=>({id:e,title:n,items:t[e]?.items??getItemsPlaceholders()}))))}P()}()},[C,v,S,c,r,a,s,i,o,function({detail:t}){log.debug("showing item",t),M?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:t.$id,type:t.type,title:t.title}})},function(t){const e=j.find((e=>e.id===t));M?(M.mutations.setSearch(e.search),M.mutations.switchToDefaultLayout()):log.warn("layoutContext is not set yet")},function(t){log.debug(t?`editing search "${t}"`:"opening search builder");const e=j.find((e=>e.id===t));M?.mutations.setModal({component:"hdl-dashboard-search-builder",type:"web-component",paramsHaveAccessors:!0,onMount(t){t.addEventListener("pin",A)},params:{messages:C?.body.buildSearch,workspaces:l,tags:g,tagaliases:h,connections:p,user:m?.user,forbiddennames:u.filter((t=>t!==e?.title)),...e}})},async function(t){if(log.debug("unpining search",t),j)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:j.filter((e=>e.id!==t))})})},M,j,d,m,f,function(t){binding_callbacks[t?"unshift":"push"]((()=>{S=t,n(2,S)}))}]}class Body extends SvelteElement{constructor(t){super();const e=document.createElement("style");e.textContent=":host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{display:flex;justify-content:center;align-items:flex-start;flex-wrap:wrap;box-sizing:border-box;padding:1.431em;grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:3.5em;row-gap:3.5em\n  }@media(min-width: 1025px){.viewport{justify-content:flex-start\n  }}hdl-dashboard-widget,hdl-dashboard-add-widget{width:25em}hdl-dashboard-add-widget{min-height:25.125em;align-self:stretch}",this.shadowRoot.appendChild(e),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:13},null,[-1,-1]),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[13]}set layoutContext(t){this.$$set({layoutContext:t}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;