import{SvelteElement,append,attr,attribute_to_object,binding_callbacks,destroy_block,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,subscribe,update_keyed_each}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{onMount,onDestroy,tick}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{getConfig}from"../../../lib/config.js";import configUpdates from"./lib/config_updates.js";import{gererateId}from"./lib/utils.js";import"../widget/index.js";import"../add_widget/index.js";import"../search_builder/index.js";import"../discovery/index.js";function get_each_context(t,e,n){const o=t.slice();return o[33]=e[n].id,o[34]=e[n].title,o[35]=e[n].items,o}function create_if_block_1(t){let e,n=[],o=new Map,i=t[2];const s=t=>t[33];for(let e=0;e<i.length;e+=1){let a=get_each_context(t,i,e),r=s(a);o.set(r,n[e]=create_each_block(r,a))}return{c(){for(let t=0;t<n.length;t+=1)n[t].c();e=empty()},m(t,o){for(let e=0;e<n.length;e+=1)n[e]&&n[e].m(t,o);insert(t,e,o)},p(t,a){30726&a[0]&&(i=t[2],n=update_keyed_each(n,a,s,1,t,i,o,e.parentNode,destroy_block,create_each_block,e,get_each_context))},d(t){for(let e=0;e<n.length;e+=1)n[e].d(t);t&&detach(e)}}}function create_each_block(t,e){let n,o,i,s,a,r,d,c;return{key:t,first:null,c(){n=element("hdl-dashboard-widget"),set_custom_element_data(n,"class","pined"),set_custom_element_data(n,"id",o=e[33]),set_custom_element_data(n,"title",i=e[34]),set_custom_element_data(n,"items",s=e[35]),set_custom_element_data(n,"messages",a=e[1]?.widget),set_custom_element_data(n,"maxvisible",r=10),this.first=n},m(t,o){insert(t,n,o),d||(c=[listen(n,"show-item-content",e[11]),listen(n,"expand",(function(){is_function(e[12](e[33]))&&e[12](e[33]).apply(this,arguments)})),listen(n,"edit",(function(){is_function(e[13](e[33]))&&e[13](e[33]).apply(this,arguments)})),listen(n,"remove",(function(){is_function(e[14](e[33]))&&e[14](e[33]).apply(this,arguments)}))],d=!0)},p(t,r){e=t,4&r[0]&&o!==(o=e[33])&&set_custom_element_data(n,"id",o),4&r[0]&&i!==(i=e[34])&&set_custom_element_data(n,"title",i),4&r[0]&&s!==(s=e[35])&&set_custom_element_data(n,"items",s),2&r[0]&&a!==(a=e[1]?.widget)&&set_custom_element_data(n,"messages",a)},d(t){t&&detach(n),d=!1,run_all(c)}}}function create_if_block(t){let e,n,o,i;return{c(){e=element("hdl-dashboard-add-widget"),set_custom_element_data(e,"title",n=t[1]?.body.addWidget)},m(n,s){insert(n,e,s),o||(i=listen(e,"click",t[13]),o=!0)},p(t,o){2&o[0]&&n!==(n=t[1]?.body.addWidget)&&set_custom_element_data(e,"title",n)},d(t){t&&detach(e),o=!1,i()}}}function create_fragment(t){let e,n,o,i,s,a,r,d,c=t[2]?.length>0&&create_if_block_1(t),l=!t[5]&&create_if_block(t);return{c(){e=element("div"),n=element("hdl-dashboard-discovery"),i=space(),s=element("section"),c&&c.c(),a=space(),l&&l.c(),this.c=noop,set_custom_element_data(n,"initload",t[0]),set_custom_element_data(n,"config",t[4]),set_custom_element_data(n,"messages",o=t[1]?.reminder),attr(s,"class","widgets"),attr(e,"class","viewport")},m(o,m){insert(o,e,m),append(e,n),append(e,i),append(e,s),c&&c.m(s,null),append(s,a),l&&l.m(s,null),t[20](e),r||(d=listen(n,"show-item-content",t[11]),r=!0)},p(t,e){1&e[0]&&set_custom_element_data(n,"initload",t[0]),16&e[0]&&set_custom_element_data(n,"config",t[4]),2&e[0]&&o!==(o=t[1]?.reminder)&&set_custom_element_data(n,"messages",o),t[2]?.length>0?c?c.p(t,e):(c=create_if_block_1(t),c.c(),c.m(s,a)):c&&(c.d(1),c=null),t[5]?l&&(l.d(1),l=null):l?l.p(t,e):(l=create_if_block(t),l.c(),l.m(s,null))},i:noop,o:noop,d(n){n&&detach(e),c&&c.d(),l&&l.d(),t[20](null),r=!1,d()}}}const log=logger.getLogger("layout/dashboard/component/body"),MAX_PINED=4,componentDisplayName="dashboard/body";function logAnyError(t){t&&log.error(t.toString())}function getItemsPlaceholders(t,e=" "){return Array.from({length:t},((t,n)=>({$id:String(n),title:getTitlePlaceholder(50,e),url:"javascript:void(0)"})))}function getTitlePlaceholder(t,e){const n=Math.round(Math.random()*t)+15;return e.repeat(n)}async function getMessages(){return(await fetch(import.meta.resolve("../assets/messages.json"))).json()}function groupBy(t,e){return e.reduce(((e,n)=>Object.assign(e,{[n[t]]:n})),{})}async function getPinedWidgetData({id:t,title:e,search:n}){try{const o=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok)return{id:t,title:e,items:await o.json()};log.error(`could not load items of "${e}"(${t}) pined search`),log.debug("search:\n",n)}catch(o){log.error(`could not load items of "${e}"(${t}) pined search:\n`,o),log.debug("search:\n",n)}}function instance(t,e,n){let o,i,s,a,r,d,c,l,m,u,p,g,h,_,f=noop,b=noop,y=noop,$=noop,w=noop;t.$$.on_destroy.push((()=>f())),t.$$.on_destroy.push((()=>b())),t.$$.on_destroy.push((()=>y())),t.$$.on_destroy.push((()=>$())),t.$$.on_destroy.push((()=>w()));const{joi:x}=window,k=createValidator("dashboard/body");let v,C,j,S,M,{layoutContext:T}=e,E=!1;function P({type:t}){if("itemsUpdate"===t)return D()}async function A(){n(0,E=!1);const t=await getConfig({layout:"dashboard",updates:configUpdates});t&&n(16,({pined:v,reminded:M}=t),v,n(4,M)),n(0,E=!0)}async function D(){for await(const t of v.map(getPinedWidgetData))if(t){const{id:e}=t;n(2,j=j.map((n=>e!==n.id?n:t))),tick().then((()=>S.querySelector("#"+e)?.scrollToTop()))}}async function I({detail:t}){log.debug("pining search",t);const e={...t,id:t.id||gererateId(t.title)},n=v?.findIndex((({id:t})=>e.id===t))??-1,o=n>=0?v.with(n,e):[...v??[],e];await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:o})}),T.mutations.setModal()}return onMount((async()=>{n(1,C=await getMessages());try{await A()}catch(t){log.error(t.toString())}})),onDestroy((()=>{T&&(T.sseClient.unsubscribe(`/api/${d}/notification`,P),T.sseClient.unsubscribe(`/api/${d}/dashboard/notification`,A),T.sseClient.offConnect(A))})),t.$$set=t=>{"layoutContext"in t&&n(15,T=t.layoutContext)},t.$$.update=()=>{32768&t.$$.dirty[0]&&(n(10,o=T?.state.session),f(),f=subscribe(o,(t=>n(18,u=t)))),32768&t.$$.dirty[0]&&(n(9,i=T?.state.workspaces),w(),w=subscribe(i,(t=>n(19,_=t)))),32768&t.$$.dirty[0]&&(n(8,s=T?.state.tags),$(),$=subscribe(s,(t=>n(25,h=t)))),32768&t.$$.dirty[0]&&(n(7,a=T?.state.connections),b(),b=subscribe(a,(t=>n(23,p=t)))),32768&t.$$.dirty[0]&&(n(6,r=T?.computed.tagAliases),y(),y=subscribe(r,(t=>n(24,g=t)))),262144&t.$$.dirty[0]&&n(17,d=encodeURIComponent(u?.user.$id)),65537&t.$$.dirty[0]&&n(5,c=!E||v?.length>=4),524288&t.$$.dirty[0]&&(l=_?.map((({name:t})=>t))),65536&t.$$.dirty[0]&&(m=v?.map((({title:t})=>t))),32768&t.$$.dirty[0]&&k(T,"layoutContext",x.object().unknown()),163840&t.$$.dirty[0]&&T&&(T.sseClient.subscribe(`/api/${d}/notification`,P,logAnyError),T.sseClient.subscribe(`/api/${d}/notification/dashboard`,A,logAnyError),T.sseClient.onConnect(A)),65536&t.$$.dirty[0]&&v&&async function(){const t=v.length-(j?.length??0);if(Math.abs(t)>0){n(2,j??=[]);const t=groupBy("id",j);n(2,j=v.map((({id:e,title:n},o)=>({id:e,title:n,items:t[e]?.items??getItemsPlaceholders(10)}))))}D()}()},[E,C,j,S,M,c,r,a,s,i,o,function({detail:t}){log.debug("showing item",t),T?.mutations.setModal({component:"content-viewer",type:"web-component",paramsHaveAccessors:!0,params:{itemid:t.$id,type:t.type,title:t.title}})},function(t){const e=v.find((e=>e.id===t));T?(T.mutations.setSearch(e.search),T.mutations.switchToDefaultLayout()):log.warn("layoutContext is not set yet")},function(t){log.debug(t?`editing search "${t}"`:"opening search builder");const e=v?.find((e=>e.id===t));T?.mutations.setModal({component:"hdl-dashboard-search-builder",type:"web-component",paramsHaveAccessors:!0,onMount(t){t.addEventListener("pin",I)},params:{messages:C?.body.buildSearch,workspaces:l,tags:h,tagaliases:g,connections:p,user:u?.user,forbiddennames:m?.filter((t=>t!==e?.title)),...e}})},async function(t){if(log.debug("unpining search",t),v)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:v.filter((e=>e.id!==t))})})},T,v,d,u,_,function(t){binding_callbacks[t?"unshift":"push"]((()=>{S=t,n(3,S)}))}]}class Body extends SvelteElement{constructor(t){super();const e=document.createElement("style");e.textContent=":host{--main-header-height:3.93em;--size-menu-width:0}@media(min-width: 1025px){:host{--size-menu-width:4.78em}}:host{padding:var(--main-header-height) 0 0 var(--size-menu-width);box-sizing:border-box;display:block;width:100%;height:100%;overflow:auto}.viewport{--row-gap:3.5em;padding:1.431em 2.5em\n  }.viewport>*:not(:last-child){margin-bottom:var(--row-gap)}.widgets{display:grid;grid-template-columns:repeat(auto-fill, minmax(25em, 1fr));grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:var(--row-gap);row-gap:var(--row-gap)}hdl-dashboard-add-widget{min-height:25.125em}",this.shadowRoot.appendChild(e),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{layoutContext:15},null,[-1,-1]),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["layoutContext"]}get layoutContext(){return this.$$.ctx[15]}set layoutContext(t){this.$$set({layoutContext:t}),flush()}}customElements.define("hdl-dashboard",Body);export default Body;