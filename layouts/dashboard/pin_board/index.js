import{SvelteElement,append,attribute_to_object,binding_callbacks,destroy_block,detach,element,empty,flush,init,insert,is_function,listen,noop,not_equal,run_all,set_custom_element_data,space,update_keyed_each}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{tick}from"../../../packages/svelte/internal/index.mjs";import{createValidator}from"../../../lib/validation.js";import{dispatchContentDisplayEvent}from"../../../lib/item.js";import"../widget/index.js";import"../add_widget/index.js";function get_each_context(e,t,n){const i=e.slice();return i[15]=t[n].id,i[16]=t[n].title,i[17]=t[n].items,i}function create_if_block_1(e){let t,n=[],i=new Map,s=e[2];const o=e=>e[15];for(let t=0;t<s.length;t+=1){let a=get_each_context(e,s,t),d=o(a);i.set(d,n[t]=create_each_block(d,a))}return{c(){for(let e=0;e<n.length;e+=1)n[e].c();t=empty()},m(e,i){for(let t=0;t<n.length;t+=1)n[t]&&n[t].m(e,i);insert(e,t,i)},p(e,a){245&a&&(s=e[2],n=update_keyed_each(n,a,o,1,e,s,i,t.parentNode,destroy_block,create_each_block,t,get_each_context))},d(e){for(let t=0;t<n.length;t+=1)n[t].d(e);e&&detach(t)}}}function create_each_block(e,t){let n,i,s,o,a,d,r,c;return{key:e,first:null,c(){n=element("hdl-dashboard-widget"),set_custom_element_data(n,"class","pined"),set_custom_element_data(n,"id",i=t[15]),set_custom_element_data(n,"title",s=t[16]),set_custom_element_data(n,"items",o=t[17]),set_custom_element_data(n,"messages",a=t[0]?.widget),set_custom_element_data(n,"maxvisible",d=10),this.first=n},m(e,i){insert(e,n,i),r||(c=[listen(n,"show-item-content",t[7]),listen(n,"expand",(function(){is_function(t[4](t[15]))&&t[4](t[15]).apply(this,arguments)})),listen(n,"edit",(function(){is_function(t[5](t[15]))&&t[5](t[15]).apply(this,arguments)})),listen(n,"remove",(function(){is_function(t[6](t[15]))&&t[6](t[15]).apply(this,arguments)}))],r=!0)},p(e,d){t=e,4&d&&i!==(i=t[15])&&set_custom_element_data(n,"id",i),4&d&&s!==(s=t[16])&&set_custom_element_data(n,"title",s),4&d&&o!==(o=t[17])&&set_custom_element_data(n,"items",o),1&d&&a!==(a=t[0]?.widget)&&set_custom_element_data(n,"messages",a)},d(e){e&&detach(n),r=!1,run_all(c)}}}function create_if_block(e){let t,n,i,s;return{c(){t=element("hdl-dashboard-add-widget"),set_custom_element_data(t,"title",n=e[0]?.addWidget)},m(n,o){insert(n,t,o),i||(s=listen(t,"click",e[5]),i=!0)},p(e,i){1&i&&n!==(n=e[0]?.addWidget)&&set_custom_element_data(t,"title",n)},d(e){e&&detach(t),i=!1,s()}}}function create_fragment(e){let t,n,i=e[2]?.length>0&&create_if_block_1(e),s=!e[3]&&create_if_block(e);return{c(){t=element("div"),i&&i.c(),n=space(),s&&s.c(),this.c=noop},m(o,a){insert(o,t,a),i&&i.m(t,null),append(t,n),s&&s.m(t,null),e[11](t)},p(e,[o]){e[2]?.length>0?i?i.p(e,o):(i=create_if_block_1(e),i.c(),i.m(t,n)):i&&(i.d(1),i=null),e[3]?s&&(s.d(1),s=null):s?s.p(e,o):(s=create_if_block(e),s.c(),s.m(t,null))},i:noop,o:noop,d(n){n&&detach(t),i&&i.d(),s&&s.d(),e[11](null)}}}const log=logger.getLogger("layout/dashboard/component/pin_board"),MAX_PINED=4,componentDisplayName="dashboard/pin_board";function getItemsPlaceholders(e,t=" "){return Array.from({length:e},((e,n)=>({$id:String(n),title:getTitlePlaceholder(50,t),url:"javascript:void(0)"})))}function getTitlePlaceholder(e,t){const n=Math.round(Math.random()*e)+15;return t.repeat(n)}function groupBy(e,t){return t.reduce(((t,n)=>Object.assign(t,{[n[e]]:n})),{})}async function getWidgetData({id:e,title:t,search:n}){try{const i=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(i.ok)return{id:e,title:t,items:await i.json()};log.error(`could not load items of "${t}"(${e}) pined search`),log.debug("search:\n",n)}catch(i){log.error(`could not load items of "${t}"(${e}) pined search:\n`,i),log.debug("search:\n",n)}}function instance(e,t,n){let i;const{joi:s}=window,o=createValidator(componentDisplayName);let a,d,{pined:r}=t,{messages:c}=t,{configfetched:l}=t;async function m(){for await(const e of r.map(getWidgetData))if(e){const{id:t}=e;n(2,d=d.map((n=>t!==n.id?n:e))),tick().then((()=>a.querySelector("#"+t)?.scrollToTop()))}}return e.$$set=e=>{"pined"in e&&n(8,r=e.pined),"messages"in e&&n(0,c=e.messages),"configfetched"in e&&n(9,l=e.configfetched)},e.$$.update=()=>{256&e.$$.dirty&&o(r,"pined",s.array().items(s.object({id:s.string().required(),title:s.string().required(),search:s.object().required()}))),1&e.$$.dirty&&o(c,"messages",s.object({widget:s.object().required(),addWidget:s.string().required()})),512&e.$$.dirty&&o(l,"configfetched",s.boolean()),768&e.$$.dirty&&n(3,i=!l||r?.length>=4),256&e.$$.dirty&&r&&async function(){const e=r.length-(d?.length??0);if(Math.abs(e)>0){n(2,d??=[]);const e=groupBy("id",d);n(2,d=r.map((({id:t,title:n},i)=>({id:t,title:n,items:e[t]?.items??getItemsPlaceholders(10)}))))}m()}()},[c,a,d,i,function(e){const{search:t}=r.find((t=>t.id===e));a?.parentNode.host.dispatchEvent(new window.CustomEvent("expand",{detail:t,bubbles:!1}))},function(e){const t=r?.find((t=>t.id===e));a?.parentNode.host.dispatchEvent(new window.CustomEvent("edit",{detail:t,bubbles:!1}))},async function(e){if(log.debug("unpining search",e),r)return fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pined:r.filter((t=>t.id!==e))})})},function({detail:e}){dispatchContentDisplayEvent({node:a,item:e})},r,l,m,function(e){binding_callbacks[e?"unshift":"push"]((()=>{a=e,n(1,a)}))}]}class Pin_board extends SvelteElement{constructor(e){super();const t=document.createElement("style");t.textContent=":host{display:grid;grid-template-columns:repeat(auto-fill, minmax(25em, 1fr));grid-column-gap:2em;-moz-column-gap:2em;column-gap:2em;grid-row-gap:3.5em;row-gap:3.5em;grid-row-gap:var(--pin-board-row-gap, 3.5em);row-gap:var(--pin-board-row-gap, 3.5em)\n  }:host>div{display:contents}hdl-dashboard-add-widget{min-height:25.125em}",this.shadowRoot.appendChild(t),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{pined:8,messages:0,configfetched:9,refresh:10},null),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["pined","messages","configfetched","refresh"]}get pined(){return this.$$.ctx[8]}set pined(e){this.$$set({pined:e}),flush()}get messages(){return this.$$.ctx[0]}set messages(e){this.$$set({messages:e}),flush()}get configfetched(){return this.$$.ctx[9]}set configfetched(e){this.$$set({configfetched:e}),flush()}get refresh(){return this.$$.ctx[10]}}customElements.define("hdl-dashboard-pin-board",Pin_board);export default Pin_board;