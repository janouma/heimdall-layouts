import{SvelteElement,attribute_to_object,binding_callbacks,detach,element,flush,init,insert,listen,noop,not_equal,set_custom_element_data}from"../../../packages/svelte/internal/index.mjs";import logger from"../../../packages/@heimdall/utils/lib/logger.mjs";import"../../../packages/joi-browser.min.js";import{createValidator}from"../../../lib/validation.js";import{dispatchContentDisplayEvent}from"../../../lib/item.js";import"../reminder/index.js";function create_if_block(t){let e,i,s;return{c(){e=element("hdl-dashboard-reminder"),set_custom_element_data(e,"items",t[2]),set_custom_element_data(e,"messages",t[0])},m(n,o){insert(n,e,o),i||(s=listen(e,"show-item-content",t[3]),i=!0)},p(t,i){4&i&&set_custom_element_data(e,"items",t[2]),1&i&&set_custom_element_data(e,"messages",t[0])},d(t){t&&detach(e),i=!1,s()}}}function create_fragment(t){let e,i=t[2]?.length>0&&create_if_block(t);return{c(){e=element("div"),i&&i.c(),this.c=noop},m(s,n){insert(s,e,n),i&&i.m(e,null),t[6](e)},p(t,[s]){t[2]?.length>0?i?i.p(t,s):(i=create_if_block(t),i.c(),i.m(e,null)):i&&(i.d(1),i=null)},i:noop,o:noop,d(s){s&&detach(e),i&&i.d(),t[6](null)}}}const log=logger.getLogger("layout/dashboard/component/discovery"),componentDisplayName="dashboard/discovery";async function fetchItems(){const t={includeDraft:!0};let e,i;{const i=await fetch("/api/count-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw new Error("could not count items");e=await i.json()}if(e>0){const s=Math.max(0,e-20),n=await fetch("/api/find-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,offset:Math.floor(Math.random()*s)})});if(!n.ok)throw new Error("could not load reminded items");i=await n.json();const o=pickItems(i);return await fetch("/api/set-config/dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reminded:{lastModified:Date.now(),items:o.map((({$id:t,title:e,url:i,snapshot:s,icon:n,type:o})=>({$id:t,title:e,url:i,snapshot:s,icon:n,type:o})))}})}),o}}function pickItems(t){const e=[...t],i=[],s=Math.min(7,e.length);for(let t=0;t<s;t++){const t=Math.floor(Math.random()*e.length);i.push(e[t]),e.splice(t,1)}return i}function instance(t,e,i){const{joi:s}=window,n=createValidator(componentDisplayName);let o,a,{config:r}=e,{messages:l}=e,{initload:c}=e;return t.$$set=t=>{"config"in t&&i(4,r=t.config),"messages"in t&&i(0,l=t.messages),"initload"in t&&i(5,c=t.initload)},t.$$.update=()=>{16&t.$$.dirty&&n(r,"config",s.object({lastModified:s.number().required(),items:s.array().items(s.object({$id:s.string().required(),title:s.string().required(),url:s.string(),snapshot:s.alternatives().try(s.string(),null),icon:s.alternatives().try(s.string(),null),type:s.string().valid("url","text","javascript","css","html","shell","python","json")}).unknown().required()).min(1)})),16&t.$$.dirty&&r&&i(2,({items:a}=r),a),6&t.$$.dirty&&o?.parentNode.host.classList.toggle("has-items",a?.length>0),32&t.$$.dirty&&c&&async function(){if(!r||Date.now()-r.lastModified>=6048e5)try{i(2,a=await fetchItems())}catch(t){log.error("could not load reminded items:\n",t)}}()},[l,o,a,function({detail:t}){dispatchContentDisplayEvent({node:o,item:t})},r,c,function(t){binding_callbacks[t?"unshift":"push"]((()=>{o=t,i(1,o)}))}]}class Discovery extends SvelteElement{constructor(t){super();const e=document.createElement("style");e.textContent=":host(.has-items){display:block}:host>div{display:contents}",this.shadowRoot.appendChild(e),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,not_equal,{config:4,messages:0,initload:5},null),t&&(t.target&&insert(t.target,this,t.anchor),t.props&&(this.$set(t.props),flush()))}static get observedAttributes(){return["config","messages","initload"]}get config(){return this.$$.ctx[4]}set config(t){this.$$set({config:t}),flush()}get messages(){return this.$$.ctx[0]}set messages(t){this.$$set({messages:t}),flush()}get initload(){return this.$$.ctx[5]}set initload(t){this.$$set({initload:t}),flush()}}customElements.define("hdl-dashboard-discovery",Discovery);export default Discovery;